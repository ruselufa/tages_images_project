# Тестирование лимитов конкурентности

## Описание

Сервис поддерживает следующие лимиты конкурентности:
- **Загрузка/скачивание файлов**: максимум 10 одновременных запросов
- **Список файлов**: максимум 100 одновременных запросов

Каждый клиент имеет свои лимиты независимо от других клиентов.

## Запуск сервера

```bash
# Запуск сервера с отображением статистики
cd file_server
go run cmd/server/main.go -stats

# Или без статистики
go run cmd/server/main.go
```

## Тестирование

### 1. Полный тест всех лимитов

```bash
# Запустите сервер в одном терминале
cd file_server && go run cmd/server/main.go -stats

# В другом терминале запустите тест
./test_requests_only.sh
```

### 2. Быстрый тест отдельных лимитов

```bash
# Тест только скачивания (15 запросов, лимит 10)
./quick_test.sh download

# Тест только списка (110 запросов, лимит 100)
./quick_test.sh list

# Тест обоих лимитов
./quick_test.sh both
```

## Ожидаемые результаты

### Тест скачивания (15 запросов)
- ✅ 10 запросов должны завершиться успешно
- ❌ 5 запросов должны быть отклонены с ошибкой "Too many conc upload/download requests, max 10"

### Тест списка (110 запросов)
- ✅ 100 запросов должны завершиться успешно
- ❌ 10 запросов должны быть отклонены с ошибкой "Too many conc list requests, max 100"

## Настройка лимитов

Лимиты настраиваются в файле `file_server/internal/middleware/concurrency.go`:

```go
uploadSemaphore: make(chan struct{}, 10),  // 10 conc req for downloading/uploading files
listSemaphore:   make(chan struct{}, 100), // 100 conc req for searching listfiles
```

## Отладка

Если лимиты не работают, проверьте:

1. **Задержки в middleware**: В файле `concurrency.go` есть задержки для тестирования:
   - Загрузка/скачивание: 500ms
   - Список: 1500ms

2. **Статистика сервера**: При запуске с флагом `-stats` сервер показывает статистику каждые 5 секунд:
   ```
   Concurrency stats: Upload/Download: 5/10 active, 15 total, | List: 20/100 active, 50 total
   ```

3. **Логи**: Проверьте логи сервера на наличие ошибок

## Структура проекта

```
├── file_server/          # gRPC сервер
│   ├── cmd/server/       # Точка входа сервера
│   ├── internal/
│   │   ├── middleware/   # Лимиты конкурентности
│   │   ├── controller/   # Бизнес-логика
│   │   └── repository/   # Работа с файлами
│   └── storage/files/    # Хранилище файлов
├── file_client/          # gRPC клиент
│   ├── cmd/client/       # Точка входа клиента
│   └── internal/client/  # Клиентская логика
└── test_*.sh            # Скрипты тестирования
```
